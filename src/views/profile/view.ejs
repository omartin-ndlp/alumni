<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mt-4">Profil de <%= displayUser.prenom %> <%= displayUser.nom %></h1>
        <% if (isOwnProfile) { %>
            <div>
                <a href="/profile/edit" class="btn btn-primary me-2">Modifier mon profil</a>
                <a href="/profile/employment" class="btn btn-info">Mes emplois</a>
            </div>
        <% } %>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">Informations personnelles</div>
                <div class="card-body">
                    <p><strong>Email:</strong> <%= displayUser.email %></p>
                    <p><strong>Année de diplôme:</strong> <%= displayUser.annee_diplome %></p>
                    <p><strong>Section:</strong> <%= displayUser.section_nom %></p>
                    <% if (displayUser.statut_emploi) { %>
                        <p><strong>Statut d'emploi:</strong> <%
                            const employmentStatusMap = {
                                'etudiant': 'Étudiant',
                                'employe': 'Employé',
                                'freelance': 'Freelance',
                                'chomeur': 'Sans emploi',
                                'entrepreneur': 'Entrepreneur',
                                'retraite': 'Retraité',
                                'autre': 'Autre'
                            };
                            %><%= employmentStatusMap[displayUser.statut_emploi] || displayUser.statut_emploi %></p>
                    <% } %>
                    <% if (displayUser.adresse && displayUser.ville && displayUser.code_postal) { %>
                        <p><strong>Adresse:</strong> <%= displayUser.adresse %>, <%= displayUser.code_postal %> <%= displayUser.ville %>, <%= displayUser.pays %></p>
                    <% } %>

                    <% if (displayUser.description) { %>
                        <hr>
                        <p><strong>Description:</strong></p>
                        <%
                            const description = displayUser.description;
                            const maxLength = 150; // Adjust as needed
                            let truncated = false;
                            let displayDescription = description;

                            if (description.length > maxLength) {
                                displayDescription = description.substring(0, maxLength) + '...';
                                truncated = true;
                            }
                        %>
                        <p class="mb-0">
                            <span class="description-truncated"><%= displayDescription %></span>
                            <span class="description-full" style="display: none;"><%= description %></span>
                            <% if (truncated) { %>
                                <a href="#" class="read-more-link" data-target="description">Voir plus</a>
                                <a href="#" class="read-less-link" data-target="description" style="display: none;">Voir moins</a>
                            <% } %>
                        </p>
                    <% } %>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">Contact</div>
                <div class="card-body">
                    <% if (canViewContact) { %>
                        <p><strong>Téléphone:</strong> <%= displayUser.telephone || 'Non renseigné' %></p>
                        <p><strong>LinkedIn:</strong> <%= displayUser.linkedin ? `<a href="${displayUser.linkedin}" target="_blank">${displayUser.linkedin}</a>` : 'Non renseigné' %></p>
                        <p><strong>Twitter:</strong> <%= displayUser.twitter ? `<a href="${displayUser.twitter}" target="_blank">${displayUser.twitter}</a>` : 'Non renseigné' %></p>
                        <p><strong>Facebook:</strong> <%= displayUser.facebook ? `<a href="${displayUser.facebook}" target="_blank">${displayUser.facebook}</a>` : 'Non renseigné' %></p>
                        <p><strong>Site Web:</strong> <%= displayUser.site_web ? `<a href="${displayUser.site_web}" target="_blank">${displayUser.site_web}</a>` : 'Non renseigné' %></p>
                    <% } else { %>
                        <p class="text-muted">Les informations de contact sont masquées par l'utilisateur.</p>
                    <% } %>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">Historique des emplois</div>
                <div class="card-body">
                    <% if (employment && employment.length > 0) { %>
                        <% employment.forEach(job => {
                            const startDate = formatDate(job.date_debut);
                            let endDate = '';
                            if (job.is_current) {
                                endDate = 'Actuel';
                            } else if (job.date_fin) {
                                endDate = formatDate(job.date_fin);
                            } else {
                                endDate = 'Date de fin non spécifiée';
                            }
                        %>
                        <div class="mb-3">
                            <h6><strong><%= job.poste %></strong> chez <strong><%= job.employer_name %></strong></h6>
                            <p class="text-muted mb-1">
                                <%= startDate %> - <%= endDate %>
                            </p>
                            <% if (job.secteur) { %><p class="text-muted mb-1"><small>Secteur: <%= job.secteur %></small></p><% } %>
                            <% if (job.ville) { %><p class="text-muted mb-0"><small>Lieu: <%= job.ville %></small></p><% } %>
                        </div>
                        <% if (employment.indexOf(job) < employment.length - 1) { %><hr><% } %>
                        <% }); %>
                    <% } else { %>
                        <p>Aucun emploi enregistré.</p>
                    <% } %>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">Photo de profil</div>
                <div class="card-body text-center">
                    <img src="<%= User.getGravatarUrl(displayUser.email, 150) %>" class="rounded-circle img-fluid gravatar-img" style="width: 150px; height: 150px; object-fit: cover;">
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle Gravatar image loading
    document.querySelectorAll('.gravatar-img').forEach(img => {
        img.addEventListener('error', function() {
            this.classList.add('d-none'); // Hide the image on error
        });
    });

    // Handle "Voir plus/moins" for description
    document.querySelectorAll('.read-more-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const target = this.dataset.target;
            document.querySelector(`.${target}-truncated`).style.display = 'none';
            document.querySelector(`.${target}-full`).style.display = 'inline';
            this.style.display = 'none';
            document.querySelector(`.read-less-link[data-target="${target}"]`).style.display = 'inline';
        });
    });

    document.querySelectorAll('.read-less-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const target = this.dataset.target;
            document.querySelector(`.${target}-truncated`).style.display = 'inline';
            document.querySelector(`.${target}-full`).style.display = 'none';
            this.style.display = 'none';
            document.querySelector(`.read-more-link[data-target="${target}"]`).style.display = 'inline';
        });
    });
});
</script>